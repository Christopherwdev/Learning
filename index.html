<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Past Paper Score Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts CDN for advanced charting -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007aff;
            --color-90: #b7e1cd; /* Green for 90%+ */
            --color-80: #b7e1cd; /* Green for 80%+ */
            --color-70: #fce8b3; /* Amber for 70%+ */
            --color-50: #fcd3b3; /* Light orange for 50%+ */
            --color-fail: #f4c7c2; /* Red for Fail */
        }
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll, table will scroll */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .table-container {
            width: 100%;
            height: calc(100vh - 50px); /* Adjust based on header/footer height */
            overflow: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 30px;
        }
        .table-container::-webkit-scrollbar {
            display: none;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }
        /* Apply full border to all cells */
        th, td {
            border: 1px solid #e2e8f0;
            padding: 0;
            white-space: nowrap;
            text-align: center;
            position: relative;
        }
        th {
            background-color: #fff;
            position: sticky;
            top: 0;
            z-index: 10; /* Z-index for sticky header row */
            padding: 0.5rem 0.75rem; /* Reduced padding */
            font-weight: 600;
            color: #4a5568;
        }
        /* Sticky first column (Year / Series) */
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 11; /* Z-index for sticky left column, higher than top row */
            background-color: #fff;
            padding: 0.25rem 0.75rem; /* Reduced padding */
            font-weight: 500;
        }
        /* Top-left corner cell (intersection of sticky row and column) */
        th:first-child {
            position: sticky;
            left: 0;
            z-index: 20; /* Highest z-index for the corner cell */
            background-color: #fff;
        }

        .score-cell {
            min-width: 80px; /* Ensures it doesn't shrink smaller */
            height: 32px; /* Smaller height */
            line-height: 32px;
            outline: none;
            transition: background-color 0.3s ease;
            display: flex; /* Use flexbox to center content */
            align-items: center;
            justify-content: center;
            font-size: 0.875rem; /* Smaller font size */
        }
        .score-cell:focus {
            box-shadow: inset 0 0 0 2px black;
        }
        .score-cell.disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            color: #6c757d;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        /* Custom Checkbox */
        .custom-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Modal specific styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .modal-body {
            padding: 1.5rem;
            flex-grow: 1;
            overflow-y: auto;
        }
        .modal-footer {
            padding: 1rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
        }

        /* Graph specific styles in overlay */
        .overlay-graphs-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 0.75rem;
            width: 100%;
        }
        .overlay-graph {
            flex-shrink: 0; /* Prevent shrinking */
            width: 50%; /* Fixed width for small graphs */
            height: 90px; /* Fixed height for small graphs */
            border-radius: 0.25rem;
            padding: 0px 5px;
            background-color: #fcfcfc;
            align-items: start;
        }
        .overlay-graph-title {
            font-size: 12px;
            font-weight: 600;
            text-align: left;
            margin-bottom: 2px;
            color: #4a5568;
            justify-content: space-between;
        }
        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 5px auto 0;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease-in-out;
            border-radius: 5px;
        }
        #bottom-actions {
           overflow: auto;
        }
        #bottom-actions::-webkit-scrollbar {
            display: none;
        }

        /* Styling for the new mean scores row */
        .mean-score-row {
            font-weight: bold;
            background-color: #e9e9e9; /* Light grey background for emphasis */
            position: sticky;
            bottom: 0;
            z-index: 15; /* Ensure it stays above other content but below header/sticky column */
        }
        .mean-score-row td {
            background-color: #e9e9e9; /* Ensure cells also have the background */
        }
        .mean-score-row td:first-child {
            background-color: #e9e9e9; /* And the sticky first column cell */
        }

        /* ApexCharts specific styling to ensure it fits well */
        #chart-skewed-dist {
            max-width: 100%; /* Ensure chart is responsive within its container */
            margin: 0; /* Remove default margin */
            padding: 0;
          
        }
    </style>

   
</head>
<body class="antialiased">

    <div id="app-container" class="w-full h-full flex flex-col box-border">

        <header class="flex justify-between items-center p-4 h-[80px]">
            <div id="left-header-content">
                <h1 class="text-2xl font-bold text-gray-800" id="header-date"></h1>
                <p class="text-xs text-gray-500 mt-1">Data saved locally in your browser</p>
            </div>

            <script src="header.js"></script>

            

            <div class="flex items-center space-x-2">
                <!-- <button class="bg-white p-2 rounded-lg shadow-md hover:bg-gray-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </button> -->
                <button id="add-year-btn" class="bg-white p-2 rounded-lg shadow-md hover:bg-gray-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </button>
                <button id="select-subjects-btn" class="btn-primary flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    <span>Select Papers</span>
                </button>
            </div>
        </header>

        <div id="table-container" class="table-container flex-grow box-content">
            <table id="scores-table">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
                <tfoot id="table-foot"></tfoot> </table>
        </div>

        <div id="bottom-actions" class="fixed p-4 bg-white rounded-lg shadow-lg z-20 transform-gpu opacity-0 invisible translate-y-20 flex flex-col items-center w-[250px] h-[265px] max-w-sm cursor-grab pt-6">
            <button id="close-bottom-actions-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 rounded-full p-1 hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            <div id="active-cell-info" class="leading-[1.2em] text-gray-700 text-sm mb-[15px] font-semibold pt-0 flex-col w-full"><span>Edexcel IAL</span><br><br><span style="font-size: 30px;">Loading...</span></div>
            <div class="flex space-x-2 mb-2 w-full">
                <button id="goto-qp-btn" class="btn-primary w-[100%]">Question</button>
                <button id="goto-ms-btn" class="btn-primary w-[100%] bg-gray-500 hover:bg-gray-600">Answer</button>
                </div>
            <div id="paper-graphs" class="overlay-graphs-container w-full">
                </div>
        </div>
    </div>

    <div id="modal-container" class="fixed inset-0 modal-overlay z-50 hidden">
        <div class="modal-content w-full max-w-4xl">
            <div class="modal-header">
                <h2 class="text-2xl font-bold text-gray-800">Select Subjects and Papers</h2>
                <p class="text-gray-600">Choose the papers you want to track. Changes are saved automatically.</p>
            </div>
            <div id="modal-content-subjects" class="modal-body no-scrollbar">
                </div>
            <div class="modal-footer">
                <button id="close-modal-btn" class="btn-primary">Done</button>
            </div>
        </div>
    </div>

    <div id="year-range-modal" class="fixed inset-0 modal-overlay z-50 hidden">
        <div class="modal-content w-full max-w-lg">
            <div class="modal-header">
                <h2 class="text-2xl font-bold text-gray-800">Set Year Range</h2>
                <p class="text-gray-600">Define the start and end year/series for your tracker.</p>
            </div>
            <div class="modal-body space-y-4">
                <div class="flex items-center space-x-4">
                    <label for="start-year" class="block text-gray-700 w-24">Start:</label>
                    <select id="start-year" class="flex-1 border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500"></select>
                    <select id="start-series" class="flex-1 border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="Jan">Jan</option>
                        <option value="Jun">Jun</option>
                        <option value="Oct">Oct</option>
                    </select>
                </div>
                <div class="flex items-center space-x-4">
                    <label for="end-year" class="block text-gray-700 w-24">End:</label>
                    <select id="end-year" class="flex-1 border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500"></select>
                    <select id="end-series" class="flex-1 border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="Jan">Jan</option>
                        <option value="Jun">Jun</option>
                        <option value="Oct">Oct</option>
                    </select>
                </div>
                <p id="year-range-error" class="text-red-500 text-sm hidden">Start date cannot be after end date.</p>
            </div>
            <div class="modal-footer">
                <button id="set-year-range-btn" class="btn-primary">Set Range</button>
                <button id="close-year-range-modal-btn" class="ml-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        // Using a new appId to avoid conflicts with previous localStorage data structure
        const appId = 'past-paper-tracker-app-v4'; 

        const subjectsData = {
            'Physics': { papers: ['Unit 1', 'Unit 2', 'Unit 3', 'Unit 4', 'Unit 5', 'Unit 6'] },
            'Chemistry': { papers: ['Unit 1', 'Unit 2', 'Unit 3', 'Unit 4', 'Unit 5', 'Unit 6'] },
            'Biology': { papers: ['Unit 1', 'Unit 2', 'Unit 3', 'Unit 4', 'Unit 5', 'Unit 6'] },
            'Math': { papers: ['P1', 'P2', 'P3', 'P4', 'M1', 'M2', 'M3', 'FP1', 'FP2', 'FP3', 'S1', 'S2', 'S3', 'D1', 'D2'] }
        };

        const paperMaxMarks = {
            'Unit 1': 80, 'Unit 2': 80, 'Unit 4': 90, 'Unit 5': 90, 'Unit 3': 50, 'Unit 6': 50,
            'P1': 75, 'P2': 75, 'P3': 75, 'P4': 75, 'M1': 75, 'M2': 75, 'M3': 75,
            'FP1': 75, 'FP2': 75, 'FP3': 75, 'S1': 75, 'S2': 75, 'S3': 75, 'D1': 75, 'D2': 75
        };
        
        // Compact series names
        const series = ['Jan', 'Jun', 'Oct'];
        // For sorting and comparison purposes
        const seriesOrder = { 'Jan': 0, 'Jun': 1, 'Oct': 2 }; 

        // Define the maximum year and series available for selection
        const maxYearSelect = 2025;
        const maxSeriesSelect = 'Jun'; // Corresponds to seriesOrder[1]

        // --- STATE ---
        let appState = {
            // Reverted default to include initial selections
            selectedPapers: { 
                'Math': ['P1', 'P2', 'P3', 'P4'],
                'Physics': ['Unit 1', 'Unit 2']
            }, 
            scores: {},
            // Default range: 2025 June to 2019 January, stored as an array of {year, series} objects
            years: [] 
        };
        
        let activeCell = null;

        // --- DOM ELEMENTS ---
        const tableContainer = document.getElementById('table-container');
        const scoresTable = document.getElementById('scores-table');
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const tableFoot = document.getElementById('table-foot'); // Get the new table foot element
        const selectSubjectsBtn = document.getElementById('select-subjects-btn');
        const modalContainer = document.getElementById('modal-container'); // Subject modal
        const closeModalBtn = document.getElementById('close-modal-btn'); // Subject modal close
        const modalContentSubjects = document.getElementById('modal-content-subjects'); // Subject modal content
        const addYearBtn = document.getElementById('add-year-btn'); 
        const bottomActions = document.getElementById('bottom-actions');
        // const gotoPaperBtn = document.getElementById('goto-paper-btn');
        // New elements for enhanced bottom actions
        const activeCellInfo = document.getElementById('active-cell-info');
        const gotoQpBtn = document.getElementById('goto-qp-btn');
        const gotoMsBtn = document.getElementById('goto-ms-btn');
        const paperGraphsContainer = document.getElementById('paper-graphs'); // Container for per-paper graphs

        // Year Range Modal Elements
        const yearRangeModal = document.getElementById('year-range-modal');
        const startYearSelect = document.getElementById('start-year');
        const startSeriesSelect = document.getElementById('start-series');
        const endYearSelect = document.getElementById('end-year');
        const endSeriesSelect = document.getElementById('end-series');
        const setYearRangeBtn = document.getElementById('set-year-range-btn');
        const closeYearRangeModalBtn = document.getElementById('close-year-range-modal-btn');
        const yearRangeError = document.getElementById('year-range-error');

        // New DOM element for the close button on the bottom actions pane
        const closeBottomActionsBtn = document.getElementById('close-bottom-actions-btn');
        const headerDateElement = document.getElementById('header-date'); // New: Get the header date element


        // --- LOCAL STORAGE FUNCTIONS ---
        function loadStateFromStorage() {
            try {
                const saved = localStorage.getItem(appId);
                if (saved) {
                    const data = JSON.parse(saved);
                    // If saved data has selectedPapers, use it, otherwise use the empty default {}
                    appState.selectedPapers = data.selectedPapers || {}; 
                    // This is important: if data.selectedPapers is empty, it means user cleared it.
                    // If it's undefined (old save), use the default.
                    if (data.selectedPapers === undefined) {
                        appState.selectedPapers = { 
                            'Math': ['P1', 'P2', 'P3', 'P4'],
                            'Physics': ['Unit 1', 'Unit 2']
                        };
                    } else {
                         appState.selectedPapers = data.selectedPapers;
                    }

                    appState.scores = data.scores || appState.scores;
                    
                    // Validate and set years. If old format or invalid, use default.
                    if (data.years && Array.isArray(data.years) && data.years.every(y => typeof y === 'object' && y.year && y.series)) {
                         appState.years = data.years;
                    } else {
                        console.warn("Invalid 'years' data in localStorage, using default range.");
                        appState.years = generateYearSeriesRange(2019, 'Jan', 2025, 'Jun');
                    }
                    // Always sort the loaded years to ensure correct display order
                    sortYearSeriesList(appState.years);
                    console.log("State loaded from localStorage:", appState);
                } else {
                    // If no state found, initialize with default year range and selected papers
                    appState.years = generateYearSeriesRange(2019, 'Jan', 2025, 'Jun');
                    appState.selectedPapers = { 
                        'Math': ['P1', 'P2', 'P3', 'P4'],
                        'Physics': ['Unit 1', 'Unit 2']
                    };
                }
            } catch (error) {
                console.error("Error loading state from localStorage:", error);
                // Fallback to default state in case of parsing error
                appState.years = generateYearSeriesRange(2019, 'Jan', 2025, 'Jun');
                appState.selectedPapers = { 
                    'Math': ['P1', 'P2', 'P3', 'P4'],
                    'Physics': ['Unit 1', 'Unit 2']
                };
            }
        }

        function saveStateToStorage() {
            try {
                localStorage.setItem(appId, JSON.stringify(appState));
                console.log("State saved to localStorage");
            } catch (error) {
                console.error("Error saving state to localStorage:", error);
            }
        }
        
        // --- RENDERING LOGIC ---
        function renderAll() {
            renderTable();
            populateModal(); // For subject selection
            initYearRangeSelectors(); // For year range selection modal
            updateHeaderDate(); // New: Update the header date
        }

        function renderTable() {
            const flatPaperList = getFlatPaperList();

            // Clear table content
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            tableFoot.innerHTML = ''; // Clear table footer too

            // If no papers selected, display a message
            if (flatPaperList.length === 0) {
                tableContainer.innerHTML = `<div class="text-center p-10 text-gray-500">No papers selected. Click 'Select Papers' to get started.</div>`;
                return;
            } else if (!document.getElementById('scores-table')) {
                // If the message was previously shown and table removed, re-add the table structure
                tableContainer.innerHTML = `<table id="scores-table">
                                                    <thead id="table-head"></thead>
                                                    <tbody id="table-body"></tbody>
                                                    <tfoot id="table-foot"></tfoot>
                                                </table>`;
            }

            // Re-query for the elements, especially if they were re-created
            const currentTableHead = document.getElementById('table-head');
            const currentTableBody = document.getElementById('table-body');
            const currentTableFoot = document.getElementById('table-foot'); // Get the foot reference again
            if (!currentTableHead || !currentTableBody || !currentTableFoot) {
                console.error("Table head, body or foot not found after potential re-creation.");
                return; 
            }

            // Render Header Row
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>Year / Series</th>'; // Top-left sticky cell
            flatPaperList.forEach(({ subject, paper }) => {
                const th = document.createElement('th');
                th.innerHTML = `<div>${subject}</div><div class="font-normal text-sm">${paper}</div>`;
                headerRow.appendChild(th);
            });
            currentTableHead.appendChild(headerRow);

            // Render Table Body Rows
            // Iterate through the sorted appState.years [{year, series}, ...]
            appState.years.forEach(({ year, series: serie }) => {
                const row = document.createElement('tr');
                const firstTd = document.createElement('td');
                // Display year and compact series name
                firstTd.textContent = `${year} ${serie}`; 
                row.appendChild(firstTd);

                flatPaperList.forEach(({ subject, paper }) => {
                    const cell = document.createElement('td');
                    const scoreCell = document.createElement('div');
                    scoreCell.classList.add('score-cell');
                    scoreCell.setAttribute('contenteditable', 'true');
                    
                    const cellId = `${year}_${serie}_${subject}_${paper}`.replace(/\s/g, '_');
                    scoreCell.dataset.id = cellId;
                    scoreCell.dataset.subject = subject;
                    scoreCell.dataset.paper = paper;
                    scoreCell.dataset.year = year;
                    scoreCell.dataset.series = serie;
                    
                    const score = appState.scores[cellId] || '';
                    scoreCell.textContent = score; // Only raw score here
                    
                    // Disable October for FP papers
                    if (serie === 'Oct' && paper.startsWith('FP')) {
                        scoreCell.setAttribute('contenteditable', 'false');
                        scoreCell.classList.add('disabled');
                        scoreCell.textContent = 'N/A';
                    }
                    
                    updateCellColor(scoreCell, score, paper); // Only color, no text content change
                    
                    cell.appendChild(scoreCell);
                    row.appendChild(cell);
                });
                currentTableBody.appendChild(row);
            });

            // Render Mean Scores Row in the footer
            const meanRow = document.createElement('tr');
            meanRow.classList.add('mean-score-row'); // Add class for styling

            const meanLabelCell = document.createElement('td');
            meanLabelCell.textContent = 'Mean Score';
            meanRow.appendChild(meanLabelCell);

            flatPaperList.forEach(({ subject, paper }) => {
                const meanScoreCell = document.createElement('td');
                const meanScoreDiv = document.createElement('div');
                meanScoreDiv.classList.add('score-cell'); // Re-use score-cell class for styling

                const mean = calculateMeanScore(subject, paper);
                const meanText = mean !== null ? mean.toFixed(1) : 'N/A'; // Format to 1 decimal place or 'N/A'
                meanScoreDiv.textContent = meanText;

                // Apply coloring to the mean score cell
                updateCellColor(meanScoreDiv, mean, paper);

                meanScoreCell.appendChild(meanScoreDiv);
                meanRow.appendChild(meanScoreCell);
            });
            currentTableFoot.appendChild(meanRow);
        }
        
        function populateModal() {
            modalContentSubjects.innerHTML = ''; // Clear previous content
            Object.entries(subjectsData).forEach(([subject, data]) => {
                const subjectDiv = document.createElement('div');
                subjectDiv.className = 'mb-6';
                
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center justify-between mb-3';
                
                const title = document.createElement('h3');
                title.className = 'text-lg font-bold text-gray-700';
                title.textContent = subject;

                const selectAllLabel = document.createElement('label');
                selectAllLabel.className = 'flex items-center space-x-2 text-sm font-medium text-gray-600 cursor-pointer';
                const selectAllCheckbox = document.createElement('input');
                selectAllCheckbox.type = 'checkbox';
                selectAllCheckbox.className = 'rounded custom-checkbox mr-2'; 
                selectAllCheckbox.dataset.subject = subject;
                selectAllCheckbox.addEventListener('change', handleSelectAllChange);
                selectAllLabel.appendChild(selectAllCheckbox);
                selectAllLabel.append('Select All');

                headerDiv.appendChild(title);
                headerDiv.appendChild(selectAllLabel);
                subjectDiv.appendChild(headerDiv);

                const papersGrid = document.createElement('div');
                papersGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3';
                
                data.papers.forEach(paper => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 p-2 rounded-md bg-gray-100 hover:bg-gray-200 transition cursor-pointer';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    // Added paper-checkbox class for easier selection in Select All logic
                    checkbox.className = 'rounded custom-checkbox mr-2 paper-checkbox'; 
                    checkbox.dataset.subject = subject;
                    // Check if the paper is already selected from appState
                    checkbox.checked = appState.selectedPapers[subject]?.includes(paper) || false;
                    checkbox.addEventListener('change', handlePaperSelectionChange);
                    
                    label.appendChild(checkbox);
                    label.append(paper);
                    papersGrid.appendChild(label);
                });

                subjectDiv.appendChild(papersGrid);
                modalContentSubjects.appendChild(subjectDiv);
                // Update the state of the "Select All" checkbox based on individual paper selections
                updateSelectAllCheckboxState(subject);
            });
        }

        function initYearRangeSelectors() {
            // Clear existing options
            startYearSelect.innerHTML = '';
            endYearSelect.innerHTML = '';

            const currentYear = new Date().getFullYear();
            // Generate years from 2000 up to maxYearSelect
            for (let year = Math.max(currentYear, maxYearSelect); year >= 2000; year--) { 
                const optionStart = document.createElement('option');
                optionStart.value = year;
                optionStart.textContent = year;
                startYearSelect.appendChild(optionStart);

                const optionEnd = document.createElement('option');
                optionEnd.value = year;
                optionEnd.textContent = year;
                endYearSelect.appendChild(optionEnd);
            }

            // Set initial selected values in the dropdowns based on current appState.years
            if (appState.years.length > 0) {
                // appState.years is sorted descending, so the first element is the latest, last is earliest.
                const latestYearSeries = appState.years[0]; 
                const earliestYearSeries = appState.years[appState.years.length - 1];

                startYearSelect.value = earliestYearSeries.year;
                startSeriesSelect.value = earliestYearSeries.series;
                endYearSelect.value = latestYearSeries.year;
                endSeriesSelect.value = latestYearSeries.series;
            } else {
                 // Fallback if appState.years is empty, though it should be initialized by loadStateFromStorage
                startYearSelect.value = 2019;
                startSeriesSelect.value = 'Jan';
                endYearSelect.value = 2025;
                endSeriesSelect.value = 'Jun';
            }
        }
        
        // New function to update the header date
        function updateHeaderDate() {
            const today = new Date();
            const options = { month: 'short', day: 'numeric' };
            headerDateElement.textContent = today.toLocaleDateString('en-US', options);
        }

        // --- UTILITY FUNCTIONS ---
        // Generates an array of {year, series} objects within the specified range
        function generateYearSeriesRange(startYear, startSeries, endYear, endSeries) {
            const result = [];
            
            // Ensure years do not go beyond the maxYearSelect/maxSeriesSelect boundary
            const actualEndYear = Math.min(endYear, maxYearSelect);
            let actualEndSeries = endSeries;
            if (endYear === maxYearSelect && seriesOrder[endSeries] > seriesOrder[maxSeriesSelect]) {
                actualEndSeries = maxSeriesSelect;
            }

            // Loop backwards from actualEndYear/actualEndSeries to startYear/startSeries
            for (let year = actualEndYear; year >= startYear; year--) {
                const currentYearSeries = [];
                for (let i = series.length - 1; i >= 0; i--) {
                    const serie = series[i];
                    // Skip series after the actual end series for the end year
                    if (year === actualEndYear && seriesOrder[serie] > seriesOrder[actualEndSeries]) {
                        continue;
                    }
                    // Skip series before the start series for the start year
                    if (year === startYear && seriesOrder[serie] < seriesOrder[startSeries]) {
                        continue;
                    }
                    currentYearSeries.push({ year, series: serie });
                }
                // Add the series for the current year in correct order (Jan, Jun, Oct)
                currentYearSeries.sort((a,b) => seriesOrder[a.series] - seriesOrder[b.series]);
                result.push(...currentYearSeries);
            }
            // Sort the generated list in descending order (latest year/series first)
            sortYearSeriesList(result);
            return result;
        }

        function sortYearSeriesList(list) {
            list.sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year; // Descending year
                return seriesOrder[b.series] - seriesOrder[a.series]; // Descending series within year
            });
        }


        function getFlatPaperList() {
            const list = [];
            Object.keys(subjectsData).forEach(subject => {
                if(appState.selectedPapers[subject]) {
                    // Sort selected papers based on the order in subjectsData
                    const sortedPapers = subjectsData[subject].papers.filter(p => appState.selectedPapers[subject].includes(p));
                    sortedPapers.forEach(paper => {
                        list.push({ subject, paper });
                    });
                }
            });
            return list;
        }

        // Updated: Only color cell, do not modify its text content
        function updateCellColor(cell, score, paper) {
            cell.style.backgroundColor = ''; // Reset background color

            if (score === '' || score === null || isNaN(score)) {
                return;
            }

            const maxMark = paperMaxMarks[paper];
            if (maxMark) {
                const percentage = ((parseFloat(score) / maxMark) * 100).toFixed(0);
                
                let color = '';
                if (percentage >= 90) color = 'var(--color-90)';
                else if (percentage >= 80) color = 'var(--color-80)';
                else if (percentage >= 60) color = 'var(--color-70)';
                else if (percentage >= 30) color = 'var(--color-50)';
                else color = 'var(--color-fail)';
                
                cell.style.backgroundColor = `${color}`;
            }
        }
        
        function updateSelectAllCheckboxState(subject) {
            // Now targets elements with the new 'paper-checkbox' class
            const allCheckboxes = modalContentSubjects.querySelectorAll(`.paper-checkbox[data-subject="${subject}"]`);
            const checkedCheckboxes = modalContentSubjects.querySelectorAll(`.paper-checkbox[data-subject="${subject}"]:checked`);
            const selectAllCheckbox = modalContentSubjects.querySelector(`input[data-subject="${subject}"][type="checkbox"]:not(.paper-checkbox)`);
            if (!selectAllCheckbox) return;

            if (allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        // Function to calculate a simplified percentile based on a skewed distribution with median at 70%
        function calculatePercentile(scorePercentage) {
            if (isNaN(scorePercentage)) return '0';
            if (scorePercentage < 0) scorePercentage = 0;
            if (scorePercentage > 100) scorePercentage = 100;

            let percentile;
            if (scorePercentage <= 70) {
                // From 0-80% score, map to 0-50th percentile (linear)
                percentile = (scorePercentage / 70) * 50;
            } else {
                // From 80-100% score, map to 50-100th percentile (linear, but stretched)
                percentile = 50 + ((scorePercentage - 70) / 20) * 50;
            }
            return percentile.toFixed(0); // Round to nearest whole number
        }

        // Function to render the small graphs in the overlay
        function renderPaperGraphs(score, maxMark) {
            paperGraphsContainer.innerHTML = ''; // Clear previous graphs

            // Score Reached Progress Bar
            const scoreProgressDiv = document.createElement('div');
            scoreProgressDiv.className = 'overlay-graph';
            let percentage = 0;
            if (score && !isNaN(score) && maxMark && maxMark > 0) {
                percentage = Math.min(100, (parseInt(score, 10) / maxMark) * 100).toFixed(0);
            }
            scoreProgressDiv.innerHTML = `
            <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: left">
              <div class="overlay-graph-title">Grade: A*</div>
                <div class="overlay-graph-title">UMS: <span class="text-center mt-1 text-gray-600">${score || 0} / 120</span></div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: ${percentage}%;"></div>
                </div>
            `;
            paperGraphsContainer.appendChild(scoreProgressDiv);

            // Skewed Normal Distribution Graph with ApexCharts
            const normalDistDiv = document.createElement('div');
            normalDistDiv.className = 'overlay-graph';
            // Corrected: Added a div with overlay-graph-title inside normalDistDiv
            normalDistDiv.innerHTML = `<div class="overlay-graph-title"></div><div id="chart-skewed-dist"></div>`; 
            paperGraphsContainer.appendChild(normalDistDiv);

            // Calculate current score's percentile
            const scorePercentage = (score && !isNaN(score) && maxMark && maxMark > 0) ? (parseFloat(score) / maxMark) * 100 : NaN;
            const currentPercentile = calculatePercentile(scorePercentage);


            // ApexCharts options for the skewed distribution
            // Data manually crafted to create a left-skewed distribution (tail to the left, peak towards higher values)
            // Median will be around 80% as requested.
            const chartOptions = {
                chart: {
                    type: "area",
                    height: 40, // Smaller height for overlay
                    toolbar: {
                        show: false // Hide toolbar
                    },
                    sparkline: {
                        enabled: true // Use sparkline mode for minimal chart
                    },
                    animations: {
                        enabled: false // Disable animations for faster rendering in overlay
                    },
                    parentHeightOffset: 0 // Remove vertical offset
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 1,
                    colors: ['var(--primary-color)']
                },
                series: [
                    {
                        name: "Distribution",
                        // Data points for a left-skewed distribution, peaking around 80-90%
                        // These are relative frequencies or densities for arbitrary bins (e.g., 0-10%, 10-20%...)
                        data: [1, 2, 5, 10, 20, 40, 70, 90, 100, 95, 80, 60, 40, 7,  2,  1] // 20 data points for 5% bins
                    },
                    
                ],
                fill: {
                    type: "gradient",
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0.9,
                        stops: [0, 90, 100],
                        colorStops: [{
                            offset: 0,
                            color: 'var(--primary-color)',
                            opacity: 0.3
                        }, {
                            offset: 100,
                            color: 'var(--primary-color)',
                            opacity: 0.1
                        }]
                    }
                },
                xaxis: {
                    categories: Array.from({length: 20}, (_, i) => `${i*5}%`), // Categories for 5% bins
                    labels: {
                        show: false // Hide x-axis labels
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    },
                    tooltip: {
                        enabled: false // Hide x-axis tooltip
                    }
                },
                yaxis: {
                    show: false // Hide y-axis
                },
                grid: {
                    show: false, // Hide grid lines
                    padding: {
                        left: -5,
                        right: -5,
                        top: -5,
                        bottom: -5
                    }
                },
                tooltip: {
                    enabled: false // Hide chart tooltip
                }
            };

            const chart = new ApexCharts(normalDistDiv.querySelector("#chart-skewed-dist"), chartOptions); // Target the correct element
            chart.render();

            // Update the title of the skewed distribution graph with the calculated percentile
            normalDistDiv.querySelector('.overlay-graph-title').textContent = `${currentPercentile}th Percentile`;
            // Add a subtitle for the median information
            const medianSubtitle = document.createElement('div');
            medianSubtitle.className = 'text-xs text-gray-500 mt-0';
            // medianSubtitle.textContent = 'Median at 80%';
            normalDistDiv.querySelector('.overlay-graph-title').insertAdjacentElement('afterend', medianSubtitle);
        }

        // --- NEW: Calculate Mean Score for a given paper ---
        function calculateMeanScore(subject, paper) {
            let totalScore = 0;
            let count = 0;

            // Iterate through all years and series to find scores for this specific paper
            appState.years.forEach(({ year, series: serie }) => {
                const cellId = `${year}_${serie}_${subject}_${paper}`.replace(/\s/g, '_');
                const scoreStr = appState.scores[cellId];
                const score = parseFloat(scoreStr); // Use parseFloat for scores

                // Only include valid numbers in the mean calculation
                if (!isNaN(score)) {
                    totalScore += score;
                    count++;
                }
            });

            if (count > 0) {
                return totalScore / count;
            } else {
                return null; // No valid scores to calculate a mean
            }
        }


        // --- DRAGGING STATE AND FUNCTIONS ---
        let isDragging = false;
        let dragOffsetX, dragOffsetY; // Offset from mouse click to element's current top-left
        let currentLeft, currentTop; // Element's current position (left, top)

        // Function to set the initial position of the bottom bar (bottom-right with 60px margin)
        function setInitialBottomBarPosition() {
            // DO NOT remove opacity-0 or translate-y-20 here. It should remain hidden initially.
            bottomActions.style.transition = 'none'; // Disable transition for initial positioning

            const rect = bottomActions.getBoundingClientRect();
            // Calculate position to be 60px from right and 60px from bottom
            currentLeft = window.innerWidth - rect.width - 60;
            currentTop = window.innerHeight - rect.height - 60; 

            bottomActions.style.left = `${currentLeft}px`;
            bottomActions.style.top = `${currentTop}px`;
            
            // Re-enable transition after positioning
            setTimeout(() => {
                bottomActions.style.transition = ''; 
            }, 50); // Small delay to allow style application
        }

        // --- DRAGGING EVENT HANDLERS ---
        function startDrag(e) {
            // Do not start drag if the event target is an interactive element within the pane
            if (e.target.closest('button') || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.getAttribute('contenteditable') === 'true') {
                return;
            }

            isDragging = true;
            bottomActions.classList.add('cursor-grabbing');
            bottomActions.classList.remove('cursor-grab');

            // Get the current computed position
            const rect = bottomActions.getBoundingClientRect();
            currentLeft = rect.left;
            currentTop = rect.top;

            // Calculate the offset from the mouse click to the top-left of the element
            dragOffsetX = e.clientX - currentLeft;
            dragOffsetY = e.clientY - currentTop;
            
            e.preventDefault(); // Prevent default browser drag behavior (e.g., text selection)
        }

        function drag(e) {
            if (!isDragging) return;

            e.preventDefault(); // Prevent default browser drag behavior

            let newX = e.clientX - dragOffsetX;
            let newY = e.clientY - dragOffsetY;

            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const rect = bottomActions.getBoundingClientRect();
            const elementWidth = rect.width;
            const elementHeight = rect.height;

            // Clamp newX and newY to stay within viewport bounds
            newX = Math.max(0, Math.min(viewportWidth - elementWidth, newX));
            newY = Math.max(0, Math.min(viewportHeight - elementHeight, newY));

            bottomActions.style.left = `${newX}px`;
            bottomActions.style.top = `${newY}px`;
        }

        function endDrag() {
            isDragging = false;
            bottomActions.classList.remove('cursor-grabbing');
            bottomActions.classList.add('cursor-grab');
        }

        function hideBottomActions() {
            bottomActions.classList.add('translate-y-20', 'opacity-0', 'invisible');
            activeCell = null;
        }

        // --- EVENT HANDLERS (for content) ---
        function handleScoreInput(e) {
            const cell = e.target;
            if (!cell.classList.contains('score-cell') || cell.getAttribute('contenteditable') === 'false') return;

            const { id, paper, subject } = cell.dataset; // Get subject here too
            const score = cell.textContent.trim(); // Get the raw input
            
            appState.scores[id] = score;
            updateCellColor(cell, score, paper); // Only update color, text remains raw input
            
            // Debounce saving to localStorage
            clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(saveStateToStorage, 500);

            // Also update the bottom action bar info and graphs
            updateBottomActions(cell);

            // Update the mean score for the specific paper when a score changes
            updateMeanScoreInTable(subject, paper);
        }

        // New function to update only the relevant mean score cell
        function updateMeanScoreInTable(subject, paper) {
            const flatPaperList = getFlatPaperList();
            const paperIndex = flatPaperList.findIndex(p => p.subject === subject && p.paper === paper);

            if (paperIndex !== -1) {
                // The first cell in the mean row is the "Mean Score" label, so add 1 to index
                const meanCellElement = tableFoot.querySelector(`.mean-score-row td:nth-child(${paperIndex + 2}) .score-cell`);
                if (meanCellElement) {
                    const mean = calculateMeanScore(subject, paper);
                    const meanText = mean !== null ? mean.toFixed(1) : 'N/A';
                    meanCellElement.textContent = meanText;
                    updateCellColor(meanCellElement, mean, paper);
                }
            }
        }


        // Modified handleCellFocus to only show the bar, not hide it on focusout
        function handleCellFocus(e) {
            const cell = e.target;
            if (!cell.classList.contains('score-cell') || cell.getAttribute('contenteditable') === 'false') {
                return; 
            }
            activeCell = cell;
            // If the pane is currently hidden, set its initial position before showing it.
            // This ensures it appears at the default bottom-right if it hasn't been dragged yet.
            if (bottomActions.classList.contains('opacity-0') || bottomActions.style.left === '' || bottomActions.style.top === '') {
                setInitialBottomBarPosition();
            }
            // Remove the classes to make it visible
            bottomActions.classList.remove('translate-y-20', 'opacity-0', 'invisible');
            updateBottomActions(activeCell);
        }

        function updateBottomActions(cell) {
            if (!cell) {
                activeCellInfo.innerHTML = '';
                paperGraphsContainer.innerHTML = ''; // Clear graphs if no cell is active
                return;
            }
            const { subject, paper, year, series } = cell.dataset;
            const rawScore = cell.textContent.trim(); 
            const maxMark = paperMaxMarks[paper];
            let percentageInfo = '';
            
            if (rawScore && !isNaN(rawScore) && maxMark) {
                const percentage = ((parseInt(rawScore, 10) / maxMark) * 100).toFixed(0);
                percentageInfo = ` (${percentage}%)`;
            }
            
            activeCellInfo.innerHTML = `<span>${subject} ${paper}</span><br><br><span style="font-size: 30px;">${series} ${year}</span><span style="font-size: 20px; font-weight: 100; color: grey">${percentageInfo}</span>`;

            // Render graphs for the active cell
            renderPaperGraphs(rawScore, maxMark);
        }

        function handleGoToPaper(type) {
            if (!activeCell) return;
            const { subject, paper, year, series } = activeCell.dataset;
            let searchTerm = `Edexcel ${subject} ${paper} ${getFullMonthName(series)} ${year}`;
            
            if (type === 'qp') {
                searchTerm += ' question paper';
            } else if (type === 'ms') {
                searchTerm += ' mark scheme';
            } else { // Default or general search
                searchTerm += ' past paper';
            }

            const url = `https://www.google.com/search?q=${encodeURIComponent(searchTerm)}`;
            window.open(url, '_blank');
        }

        function handlePaperSelectionChange(e) {
            const { subject, paper } = e.target.dataset;
            
            if (!appState.selectedPapers[subject]) {
                appState.selectedPapers[subject] = [];
            }
            
            if (e.target.checked) {
                if (!appState.selectedPapers[subject].includes(paper)) {
                    appState.selectedPapers[subject].push(paper);
                }
            } else {
                appState.selectedPapers[subject] = appState.selectedPapers[subject].filter(p => p !== paper);
                if(appState.selectedPapers[subject].length === 0) {
                    delete appState.selectedPapers[subject];
                }
            }
            updateSelectAllCheckboxState(subject);
            saveStateToStorage(); // Save immediately on selection change
        }

        function handleSelectAllChange(e) {
            const subject = e.target.dataset.subject;
            const papers = subjectsData[subject].papers;
            // Targets elements with the 'paper-checkbox' class
            const paperCheckboxes = modalContentSubjects.querySelectorAll(`.paper-checkbox[data-subject="${subject}"]`);

            if (e.target.checked) {
                appState.selectedPapers[subject] = [...papers];
                paperCheckboxes.forEach(cb => cb.checked = true);
            } else {
                delete appState.selectedPapers[subject];
                paperCheckboxes.forEach(cb => cb.checked = false);
            }
            // Update the "Select All" checkbox state after individual paper changes
            updateSelectAllCheckboxState(subject);
            saveStateToStorage();
        }

        function handleOpenYearRangeModal() {
            // Populate year selectors before showing the modal
            initYearRangeSelectors();
            yearRangeModal.classList.remove('hidden');
            // Hide error message initially
            yearRangeError.classList.add('hidden'); 
        }

        function handleSetYearRange() {
            const startYear = parseInt(startYearSelect.value);
            const startSeries = startSeriesSelect.value;
            const endYear = parseInt(endYearSelect.value);
            const endSeries = endSeriesSelect.value;

            // Date validation: start date must be before or equal to end date
            const startDateWeight = startYear * 100 + seriesOrder[startSeries];
            const endDateWeight = endYear * 100 + seriesOrder[endSeries];

            if (startDateWeight > endDateWeight) {
                yearRangeError.classList.remove('hidden');
                return;
            } else {
                yearRangeError.classList.add('hidden');
            }

            // Generate the new year/series list
            const newYears = generateYearSeriesRange(startYear, startSeries, endYear, endSeries);
            appState.years = newYears;
            
            saveStateToStorage();
            renderTable(); // Re-render table completely when year range changes
            yearRangeModal.classList.add('hidden');
        }

        // --- EVENT LISTENERS ---
        selectSubjectsBtn.addEventListener('click', () => modalContainer.classList.remove('hidden'));
        closeModalBtn.addEventListener('click', () => {
            modalContainer.classList.add('hidden');
            renderTable(); // Re-render table in case selections changed column order
        });
        // Close subject modal if clicking outside
        modalContainer.addEventListener('click', (e) => {
            if (e.target === modalContainer) {
                modalContainer.classList.add('hidden');
                renderTable();
            }
        });

        tableContainer.addEventListener('input', handleScoreInput);
        tableContainer.addEventListener('focusin', handleCellFocus);
        
        addYearBtn.addEventListener('click', handleOpenYearRangeModal); 
        setYearRangeBtn.addEventListener('click', handleSetYearRange);
        closeYearRangeModalBtn.addEventListener('click', () => yearRangeModal.classList.add('hidden'));
        // Close year range modal if clicking outside
        yearRangeModal.addEventListener('click', (e) => {
            if (e.target === yearRangeModal) {
                yearRangeModal.classList.add('hidden');
            }
        });

        // Event listeners for the action buttons in the overlay
        gotoQpBtn.addEventListener('click', () => handleGoToPaper('qp'));
        gotoMsBtn.addEventListener('click', () => handleGoToPaper('ms'));
        
        // Draggable functionality for bottomActions
        bottomActions.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);

        // Close button for bottomActions
        closeBottomActionsBtn.addEventListener('click', hideBottomActions);

        // --- STARTUP ---
        loadStateFromStorage();
        renderAll(); // Renders table and initializes both modals (subjects and year range)

        // Set the initial position of the draggable bottom bar on page load
        window.addEventListener('load', setInitialBottomBarPosition);

        // Hide the bottom actions pane initially
        bottomActions.classList.add('opacity-0', 'translate-y-20','invisible');
    </script>
</body>
</html>
